# CLAUDE.md — 统一回答与可追溯日志规范

> 目标：为本项目提供**一致、可复现、可审计**的 AI 助手回答流程与日志格式，确保每次回答都包含清晰步骤并可直接记录到 `docs/answers-log.md`。

---

## 🧭 使用范围与目标

* **适用任务**：代码修改、调试排错、文档撰写、需求澄清、架构评审、运维脚本等。
* **总体目标**：每条回答**显式**包含步骤（RSP 流程），并产出可粘贴的**YAML 记录**。

---

## 🧭 项目结构

travel-agent-minimal/
├── backend/                 # 后端服务
│   ├── app/
│   │   ├── core/           # 配置管理
│   │   ├── routers/        # API路由
│   │   ├── schemas/        # 数据模型
│   │   ├── services/       # 业务逻辑
│   │   └── utils/          # 工具函数
│   ├── requirements.txt     # Python依赖
│   └── test_api.py         # 测试脚本
├── frontend/                # 前端应用
│   ├── src/
│   │   ├── components/     # Vue组件
│   │   ├── pages/          # 页面组件
│   │   └── api/            # API调用
│   └── package.json        # Node.js依赖
└── README.md               # 项目说明

## 🚀 运行与调试（Backend）

```bash
# 启动后端服务
source venv/bin/activate
uvicorn app.main:app --reload --port 8000

# 启动前端服务
cd frontend
npm i
npm run dev

```


---

## ✅ 回答标准流程（RSP：Response Steps Protocol）

> **每次回答必须包含以下 6 部分（顺序与标题固定）**

### 1) 目标（Objective）

* 用 1–2 句话复述当前问题/需求的核心目标。
* **假设/边界**：列出前提、范围限制。

### 2) 计划（Plan / Steps）

* 给出可执行的**编号步骤**（1、2、3…），每步尽量 1 行描述。
* **并行/可选路径**：用子编号（1.1 / 1.2）。

### 3) 执行（Execution）

* 说明关键动作与修改位置（文件/函数/命令）。
* 代码改动给出**最小可审核片段**或**关键 diff 摘要**。

### 4) 校验（Verification）

* 列出检查项（构建/测试/静态检查/复现场景），并用 ✅/❌ 标记。
* 必要时附简明结论（通过数、要点报错等）。

### 5) 结果（Outcome）

* 最终结论与产物位置（路径、接口、脚本）。
* 明确**风险/未知点**（如仍需跟进）。

### 6) 后续（Next Actions）

* 给出 1–3 条**可直接执行**的下一步。

#### RSP 回复骨架（可直接粘贴复用）

```md
### 目标（Objective）
-
- 假设：

### 计划（Plan / Steps）
1.
2.
3.

### 执行（Execution）
- 关键改动：
  - `path/to/file`: 概述变更
- 关键命令：
  -

### 校验（Verification）
- ✅ build：
- ✅/❌ tests：
- 其他：

### 结果（Outcome）
-

### 后续（Next Actions）
-
-
```

---



## 🧷 回答日志（必须随回答产出）

> 将下方模板中的 `{{ }}` 替换为真实值，粘贴到回答末尾的「记录（Log Entry）」代码块；随后手动加入 `docs/answers-log.md`。字段保持**最小完全集**，并允许在项目需要时添加扩展字段。

```yaml
# ---- ANSWER LOG ENTRY ----
question: "回答的问题记录，原封不对"
when: "{{UTC 时间 ISO8601}}"
author: "Claude"
issue: "{{关联 Issue/需求/聊天链接}}"
objective: "{{本次回答的目标一句话}}"
steps:
  - "{{步骤 1}}"
  - "{{步骤 2}}"
  - "{{步骤 3}}"
artifacts:
  - path: "{{修改/生成的文件路径}}"
    note: "{{说明}}"
verification:
  - check: "{{构建/测试/验证项}}"
    result: "pass|fail"
    details: "{{简要结论/指标}}"
outcome: "{{最终结论/影响面}}"
next:
  - "{{下一步 1}}"
  - "{{下一步 2}}"
# ---------------------------
```

> **提示**：遇到阻塞（如 524/网络超时/权限不足）也按同样结构回答，并在「校验」部分列出排查与缓解动作（带 ✅/❌ 标签）。

---

## 🧪 常见任务最小检查清单

* **代码修改**：`build` 通过 → `lint` 无新警告 → 相关 `test` 通过 → 关键路径手测/脚本验证。
* **排错修复**：稳定复现 → 定位根因 → 最小修复 → 复现用例变绿 → 回归检查 → 记录教训。
* **文档变更**：标题与导航正确 → 示例可运行/可复制 → 链接有效 → 与 README/现行规则一致。

---

## 🛠️ 项目命令（占位示例）

```bash
# 安装依赖
npm install

# 构建
npm run build

# Lint
npm run lint

# 测试
npm test

# 开发调试
npm run dev
```

---

## 🧯 故障与超时（含 524）应对规范（ErrFlow）

1. **快速分段**：缩小分析范围（子目录/单模块），避免整仓扫描超时。
2. **超时预算**：单次操作上限 60–90s；超时则降级（离线索引/逐步扫描）。
3. **重试策略**：指数退避（1s→2s→5s→…，最多 4 次），每次只变更一个变量（范围/并发/缓存）。
4. **最小可复现**：输出最小复现脚本或命令，便于复查。
5. **记录**：在「校验」列出尝试路径与现象，全部标记 ✅/❌。

---

## 🔏 规范与边界

* 不泄露密钥/私密配置；示例使用占位符（`<TOKEN>`）。
* 对不可确定信息，显式写在「假设」。
* **不得**省略「目标/步骤/校验/结果/后续」五大块。

---

## 📐 工程与代码规范（整合 Core Beliefs / Process / Standards）

### 核心信条（Core Beliefs）

* **小步快跑**：小而可测的变更，能编译且通过测试。
* **先学再做**：阅读现有代码，按惯例实现。
* **实用优先**：结合项目现实取舍。
* **意图清晰**：代码应可读、可维护，避免炫技。

### 简单之道（Simplicity Means）

* 函数/类**单一职责**。
* 避免过早抽象；不玩“聪明技巧”。
* 需要长篇解释的实现往往过度复杂。
* 优先修改配置

### 过程（Process）

1. **规划与分阶段（IMPLEMENTATION\_PLAN.md）**

   * Stage N: \[Name]

     * **Goal**：具体可交付物
     * **Success Criteria**：可测试的结果
     * **Tests**：明确用例
     * **Status**：Not Started | In Progress | Complete
   * 全部完成后可移除此文件。

2. **实现流（红绿重构）**

   * 了解 → 写测试（红）→ 最小实现（绿）→ 重构（绿）。
   * 每次提交均通过现有/新增测试与格式检查。

3. **卡住时（最多 3 次尝试）**

   * 记录：尝试过什么、具体报错、可能原因。
   * 调研：2–3 个相似实现与差异。
   * 反思：抽象层是否合适？是否可拆分/更简单？

### 技术标准（Technical Standards）

* 组合优于继承；使用依赖注入。
* 接口优于单例；提升可测性与灵活性。
* 显式依赖；数据流清晰。
* **TDD 尽可能**；**永不**禁用测试。

### 代码质量（Code Quality）

* 每次提交：可编译、测试全绿、为新功能补充测试、遵循格式化与 Lint 规则。
* 提交前：跑格式化/静态检查，自审变更，提交信息说明**为什么**。

### 错误处理（Error Handling）

* 快速失败，报错信息具上下文。
* 在合适层面兜底，**不要**静默吞错。

### 决策框架（Decision Framework）

* 可测性、可读性、一致性、简单性、可逆性。

### 项目集成（Project Integration）

* 找到 3 个相似实现并对齐风格。
* 复用既有库/工具/测试模式。

### 质量闸门（Definition of Done）

* 测试完整并通过；
* 符合项目约定；
* 无 Lint/格式化警告；
* 提交信息清晰；
* 与实现计划一致；
* 无无编号 TODO。

### 测试指南（Testing Guidelines）

* 测行为不测实现；
* 能少断言就少；
* 用场景式命名；
* 利用既有测试工具；
* 测试必须可复现/确定性。

### 重要提醒（Never / Always）

* **切勿**：用 `--no-verify` 跳过钩子；禁用测试；提交不可编译代码；无验证地做假设。
* **务必**：增量提交；持续更新计划文档；学习既有实现；**三次失败即停下复盘**。

---

## 📎 附：RSP + 日志最小示例

````md
### 目标（Objective）
- 修复 X 问题，确保 Y 接口稳定返回。

### 计划（Plan / Steps）
1. 复现问题并定位根因。
2. 提交最小修复与单测。
3. 回归相关路径并记录日志。

### 执行（Execution）
- 关键改动：
  - `src/x.ts`: 修复空指针判断
  - `tests/x.test.ts`: 增加边界用例

### 校验（Verification）
- ✅ build：`npm run build` 通过
- ✅ tests：`npm test` 全绿（新增 2/2）

### 结果（Outcome）
- 已修复并覆盖边界条件。

### 后续（Next Actions）
- 上线灰度 10%。
- 观察指标 24h。

### 记录（Log Entry）
```yaml
when: "{{UTC 时间 ISO8601}}"
author: "Claude"
issue: "#1234"
objective: "修复 X 空指针导致的 500"
steps:
  - "复现并定位"
  - "最小修复 + 单测"
  - "回归与记录"
artifacts:
  - path: "src/x.ts"
    note: "空指针修复"
verification:
  - check: "unit-tests"
    result: "pass"
    details: "新增 2，用例总数 128"
outcome: "服务 5xx 下降"
next:
  - "灰度发布"
  - "监控 24h"
```
````

